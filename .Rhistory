# folder to store the plots
figure_directory <- here("output", "decomposition", "AUS", paste0(gsub("-", "", Sys.Date())))
dir.create(figure_directory, recursive = TRUE, showWarnings = FALSE)
#Loop
plots_list <- list()
for (element in elements) {
# Create the plot
current_plot <- aus %>%
group_by(Pathway_code) %>%
ggplot(aes(x = Year, y = !!sym(paste0("diff_", element)))) +
geom_hline(yintercept = 0, linetype = "solid") +
geom_bar(stat = "identity", data = filter(aus, !str_detect(Pathway, "complete")),
aes(fill = scenarios)) +
guides(fill = guide_legend(override.aes = list(shape = NA))) +
geom_point(data = filter(aus, Pathway %in% c("NC_complete", "GS_complete")),
aes(y = !!sym(paste0("diff_", element)), x = Year, color = "All scenarios combined"),
size = 3, shape = 16) +
# geom_point(data = filter(aus, Pathway %in% c("NC_tradeeffect", "GS_tradeeffect")),
#            aes(y = !!sym(paste0("diff_", element)), x = Year, color = "NC/GS Trade adjustment effect on CT"),
#            size = 3, shape = 16, alpha =0.7) +
scale_color_manual(values = c("black"), name = "",
labels = c("All scenarios combined")) +
labs(
title = paste("Decomposition analysis:\n",element_labels[element]),
x = "Year",
y = paste("Compared to Current Trend \n", units_labels[element])
) +
facet_grid(. ~ Pathway_code, scales = "free_y",
labeller = labeller(Pathway_code = c(
"NC" = "National Commitments",
"GS" = "Global Sustainability"
))) +
scale_fill_manual(values = pathway_colors[pathway_colors != "complete"], name = "Scenarios", labels = pathway_labels[pathway_labels != "complete"]) +
scale_x_continuous(breaks = unique(aus$Year[!is.na(aus[, paste0("diff_", element)])])) +
theme_minimal() +
theme(
text = element_text(family = "Arial", color = "black", size = 18, face = "bold"),
legend.title = element_text(family = "Arial", color = "steelblue", size = 16, face = "bold"),
legend.text = element_text(family = "Arial", size = 18),
plot.title = element_text(color = "steelblue", size = 20, face = "bold"),
axis.title.x = element_text(color = "steelblue", size = 18),
axis.title.y = element_text(color = "steelblue", size = 18)
)
# Save the current plot as TIFF
# tiff(
#   filename = here(figure_directory, paste0(element, ".tiff")),
#   units = "in", height = 5, width = 14, res = 600
# )
# print(current_plot)
# dev.off()
# Append the current plot to the list
plots_list[[element]] <- current_plot
}
plots_list
aus_data <- read_xlsx(here("data", "report_AUS_20240306_9H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
select(Location, Pathway, Year, kcal_feas,
ForestChange, CalcCropland, CalcPasture, CalcOtherLand,
CalcFarmLabourFTE,
CalcCropN2O, CalcCropCH4, CalcCropCO2, CalcLiveN2O, CalcLiveCH4, CalcDeforCO2, CalcOtherLUCCO2, CalcSequestCO2,
kcal_feas, kcal_mder,
LNPPMatureForest, LNPPMatureOtherLand,
CalcN_org, CalcN_synth,
CalcWFblue) %>%
mutate(Cropland_change = CalcCropland - lag(CalcCropland)) %>%
mutate(Pasture_change = CalcPasture - lag(CalcPasture)) %>%
mutate(OtherLand_change = CalcOtherLand - lag(CalcOtherLand)) %>%
filter(Year %in% c("2030", "2050")) %>%
mutate(CO2 = CalcCropCO2 + CalcDeforCO2 + CalcOtherLUCCO2 + CalcSequestCO2) %>%
mutate(CH4 = CalcCropCH4 + CalcLiveCH4) %>%
mutate(N2O = CalcCropN2O + CalcLiveN2O) %>%
left_join(N) %>%
mutate(TotalN = CalcN_org + CalcN_synth + CalcNLeftPasture, na.rm =TRUE)
View(aus)
View(aus_data)
aus_data <- read_xlsx(here("data", "report_AUS_20240306_9H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
select(Location, Pathway, Year, kcal_feas,
ForestChange, CalcCropland, CalcPasture, CalcOtherLand,
CalcFarmLabourFTE,
CalcCropN2O, CalcCropCH4, CalcCropCO2, CalcLiveN2O, CalcLiveCH4, CalcDeforCO2, CalcOtherLUCCO2, CalcSequestCO2,
kcal_feas, kcal_mder,
LNPPMatureForest, LNPPMatureOtherLand,
CalcN_org, CalcN_synth,
CalcWFblue) %>%
mutate(Cropland_change = CalcCropland - lag(CalcCropland)) %>%
mutate(Pasture_change = CalcPasture - lag(CalcPasture)) %>%
mutate(OtherLand_change = CalcOtherLand - lag(CalcOtherLand)) %>%
filter(Year %in% c("2030", "2050")) %>%
mutate(CO2 = CalcCropCO2 + CalcDeforCO2 + CalcOtherLUCCO2 + CalcSequestCO2) %>%
mutate(CH4 = CalcCropCH4 + CalcLiveCH4) %>%
mutate(N2O = CalcCropN2O + CalcLiveN2O) %>%
left_join(N) %>%
mutate(TotalN = sum(CalcN_org, CalcN_synth, CalcNLeftPasture, na.rm = TRUE))
View(aus_data)
# N
# libraries ---------------------------------------------------------------
library(here)
#library(plyr)
library(dplyr)
library(tidyr)
library(readxl)
library(readr)
library(reshape2)
library(ggplot2)
library(stringr)
library(conflicted)
library(writexl)
library(openxlsx)
here()
conflicted::conflict_prefer("rename", "dplyr")
conflicted::conflict_prefer("mutate", "dplyr")
conflicted::conflict_prefer("summarise", "dplyr")
conflicted::conflicts_prefer(dplyr::filter)
aus_data <- read_xlsx(here("data", "report_AUS_20240306_9H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_affor", "GS_live_rumdensity"))
bra_data <- read_xlsx(here("data", "report_BRA_20240306_10H44.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_agrexp", "GS_diet", "GS_crop"))
col_data <- read_xlsx(here("data", "report_COL_20240325_15H07.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_crop", "GS_pop_urban"))
eth_data <- read_xlsx(here("data", "report_ETH_20240426_12H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_pop", "GS_agrexp", "GS_crop"))
gbr_data <- read_xlsx(here("data", "report_GBR_20240306_10H43.xlsx"), sheet = "Indicators")  %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_foodwaste", "GS_crop"))
all_data <- aus_data %>%
bind_rows(bra_data) %>%
bind_rows(col_data) %>%
bind_rows(eth_data) %>%
bind_rows(gbr_data) %>%
rename(country = Location, year = Year, pathway = Pathway, calcn_org = CalcN_org, calcn_synth = CalcN_synth) %>%
mutate(pathway = if_else(pathway == "Current Trend_Yes", "CurrentTrend", pathway)) %>%
mutate(country = ifelse(country == "Australia", "AUS",
ifelse(country == "Brazil", "BRA",
ifelse(country == "Ethiopia", "ETH",
ifelse(country == "UK", "GBR",
ifelse(country == "Colombia", "COL", country))))))
View(all_data)
db_herd <- read_excel(here("data",  "Manure", "240513_Extracted_herdsize.xlsx")) %>%
# mutate(ALPHA3 = ifelse(ALPHA3 == "RME", "NMC",
#                        ifelse(nchar(ALPHA3)>3, stringr::str_sub(ALPHA3, 2, 4), ALPHA3))) %>%
select(-ALPHA3) %>%
rename(ALPHA3 = country) %>%
mutate(TLU = as.numeric(FinFeasHerd)) %>%
select(-FinFeasHerd)
db_manure <- read_excel(here("data", "Manure", "Nmanure_GAMS.xlsx"),
sheet = "All_Nmanure_TLU") %>%
filter(!(is.na(ALPHA3))) %>%
pivot_longer(!ALPHA3, values_to = "Nmanure_TLU", names_to = "ANIMAL_GLOBIOM")
View(db_manure)
#Total N inputs from manure in 1000 t N for each year
db_manure_herd <- db_herd %>%
mutate(ANIMAL_GLOBIOM = ifelse(ANIMAL_GLOBIOM == "SGTD", "SGTO", ANIMAL_GLOBIOM)) %>%
left_join(db_manure) %>%
mutate(Nmanure_Anim = Nmanure_TLU*TLU/1000) %>%
group_by(Pathway, ALPHA3, YEAR) %>%
reframe(NManure = sum(Nmanure_Anim, na.rm = T)) %>%
rename_all(tolower) %>%
rename(country = alpha3) %>%
filter(!is.na(year))
View(db_manure_herd)
db_manure_herd <- db_herd %>%
mutate(ANIMAL_GLOBIOM = ifelse(ANIMAL_GLOBIOM == "SGTD", "SGTO", ANIMAL_GLOBIOM)) %>%
left_join(db_manure) %>%
mutate(Nmanure_Anim = Nmanure_TLU*TLU/1000)
View(db_manure_herd)
View(db_manure_herd)
# N
# libraries ---------------------------------------------------------------
library(here)
#library(plyr)
library(dplyr)
library(tidyr)
library(readxl)
library(readr)
library(reshape2)
library(ggplot2)
library(stringr)
library(conflicted)
library(writexl)
library(openxlsx)
here()
conflicted::conflict_prefer("rename", "dplyr")
conflicted::conflict_prefer("mutate", "dplyr")
conflicted::conflict_prefer("summarise", "dplyr")
conflicted::conflicts_prefer(dplyr::filter)
aus_data <- read_xlsx(here("data", "report_AUS_20240306_9H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_affor", "GS_live_rumdensity"))
bra_data <- read_xlsx(here("data", "report_BRA_20240306_10H44.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_agrexp", "GS_diet", "GS_crop"))
col_data <- read_xlsx(here("data", "report_COL_20240325_15H07.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_crop", "GS_pop_urban"))
eth_data <- read_xlsx(here("data", "report_ETH_20240426_12H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_pop", "GS_agrexp", "GS_crop"))
gbr_data <- read_xlsx(here("data", "report_GBR_20240306_10H43.xlsx"), sheet = "Indicators")  %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_foodwaste", "GS_crop"))
all_data <- aus_data %>%
bind_rows(bra_data) %>%
bind_rows(col_data) %>%
bind_rows(eth_data) %>%
bind_rows(gbr_data) %>%
rename(country = Location, year = Year, pathway = Pathway, calcn_org = CalcN_org, calcn_synth = CalcN_synth) %>%
mutate(pathway = if_else(pathway == "Current Trend_Yes", "CurrentTrend", pathway)) %>%
mutate(country = ifelse(country == "Australia", "AUS",
ifelse(country == "Brazil", "BRA",
ifelse(country == "Ethiopia", "ETH",
ifelse(country == "UK", "GBR",
ifelse(country == "Colombia", "COL", country))))))
# file --------------------------------------------------------------------
file <- list.files(path = here("data", "SOFA extraction"))
#Extracting data from the Calculators - only run when needed
#<<<<<<< HEAD
#
# db_full <- data.frame()
#
# for (cur_file in file){
#   print(cur_file)
#   #???Extract the right sheet from calculators
#    data <- read_excel(here("data", "SOFA extraction", cur_file),
#                      sheet = "5_feas_livestock",
#                      range = "AA20:BZ175")
#   index <- which(data == "TABLE: Calc_FeasProdLivestock" | data == "TABLE: Calc_FeasProdLivestok", arr.ind = T)
#
#   if(!plyr::empty(index)){#Don't know if the table is in the calculator; we check before digging in
#     #if it is in the calc than we only want a certain amount of columns after "Biofuel_scen" cell
#     data <- data[c((index[1,1]+7):nrow(data)), c(index[1,2]:(index[1,2]+30))]
#     colnames(data) <- data[1,]
#     data <- data[-1,]
#     data <- data.frame(data[rowSums(is.na(data)) != ncol(data), ])
#
#
#     data <- data %>%
#       #slice(which(Year %in% c(2015, 2050))) %>%
#       select(ANIMAL_GLOBIOM, YEAR, FinFeasHerd) %>%
#       mutate(Pathway = ifelse(grepl("affor", cur_file),
#                               "GS_affor",
#                               ifelse(grepl("diet", cur_file),
#                                      "GS_diet",
#                                      ifelse(grepl("liverum", cur_file),
#                                             "GS_live_rum",
#                                             ifelse(grepl("agrexp", cur_file),
#                                                    "GS_agrexp",
#                                                    ifelse(grepl("crop", cur_file),
#                                                           "GS_crop",
#                                                           ifelse(grepl("popurban", cur_file),
#                                                                  "GS_pop_urban",
#                                                                  ifelse(grepl("pop", cur_file),
#                                                                         "GS_pop",
#                                                                         ifelse(grepl("foodwaste", cur_file),
#                                                                                "GS_foodwaste",
#                                                                                ifelse(grepl("Current", cur_file),
#                                                                                       "CurrentTrend",
#                                                                                       ifelse(grepl("National", cur_file),
#                                                                                              "NationalCommitments",
#                                                                                              "GlobalSustainability"))))))))))) %>%
#       mutate(ALPHA3 = ifelse(grepl("AUS", cur_file), "AUS",
#                              ifelse(grepl("BRA", cur_file), "BRA",
#                                     ifelse(grepl("COL", cur_file), "COL",
#                                            ifelse(grepl("ETH", cur_file), "ETH",
#                                                   ifelse(grepl("GBR", cur_file), "GBR",
#                                                          ifelse(grepl("Current", cur_file),
#                                                                 str_sub(cur_file, 40, 42),
#                                                                 ifelse(grepl("National", cur_file),
#                                                                        str_sub(cur_file, 46, 48),
#                                                                        str_sub(cur_file, 47, 49))))))))) %>%
#       unique()
#   }
#
#
#   db_full <- db_full %>%
#     rbind.data.frame(data) %>%
#     dplyr::mutate(ALPHA3 = gsub("_", "", ALPHA3))
# }
#
# db_herd <- db_full %>%
#   select(Pathway, ALPHA3, ANIMAL_GLOBIOM, YEAR, FinFeasHerd) %>%
#   mutate(country = ifelse(nchar(ALPHA3) == 4 , substr(ALPHA3, 2, 4),
#                           ifelse(ALPHA3 == "RME", "NMC", ALPHA3))) %>%
#   data.frame()
#
# xlsx::write.xlsx(db_herd, file = here("data",  "Manure", paste0(format(Sys.Date(),format = "%y%m%d"), "_Extracted_herdsize.xlsx")), row.names = F)
db_herd <- read_excel(here("data",  "Manure", "240513_Extracted_herdsize.xlsx")) %>%
# mutate(ALPHA3 = ifelse(ALPHA3 == "RME", "NMC",
#                        ifelse(nchar(ALPHA3)>3, stringr::str_sub(ALPHA3, 2, 4), ALPHA3))) %>%
select(-ALPHA3) %>%
rename(ALPHA3 = country) %>%
mutate(TLU = as.numeric(FinFeasHerd)) %>%
select(-FinFeasHerd)
# merge with GAMS manure data ----------------------------------------------
db_manure <- read_excel(here("data", "Manure", "Nmanure_GAMS.xlsx"),
sheet = "All_Nmanure_TLU") %>%
filter(!(is.na(ALPHA3))) %>%
pivot_longer(!ALPHA3, values_to = "Nmanure_TLU", names_to = "ANIMAL_GLOBIOM")
#Total N inputs from manure in 1000 t N for each year
db_manure_herd <- db_herd %>%
mutate(ANIMAL_GLOBIOM = ifelse(ANIMAL_GLOBIOM == "SGTD", "SGTO", ANIMAL_GLOBIOM)) %>%
left_join(db_manure) %>%
mutate(Nmanure_Anim = Nmanure_TLU*TLU/1000) %>%
group_by(Pathway, ALPHA3, YEAR) %>%
reframe(NManure = sum(Nmanure_Anim, na.rm = T)) %>%
rename_all(tolower) %>%
rename(country = alpha3) %>%
filter(!is.na(year))
# ggplot(db_manure_herd) +
#   geom_line(aes(x = as.numeric(year), y = nmanure, linetype = pathway, colour = pathway),
#             linewidth = 1)+
#   facet_wrap(~country)
# CalcNLeftpasture in 1000 t N
db_N <- all_data %>%
select(pathway, country, year, calcn_org, calcn_synth) %>%
######################### CAREFUL ONLY HAVE EXTRACTED WITH TRADE ADJUSTMENT ###############################
#filter(tradeadjustment == "Yes") %>%
################################################################################
mutate(year = as.character(year))
# mutate(country = gsub("_", "", country)) %>%
# mutate(country = ifelse(country == "RMECAS", "NMC",
#                         ifelse(nchar(country)>3, stringr::str_sub(country, 2, 4), country)))
db_NleftPasture <- db_manure_herd %>%
left_join(db_N) %>%
mutate(NPasture_beforeadj = nmanure - calcn_org,
CalcNLeftPasture = pmax(0, nmanure - calcn_org))
# ggplot(db_NleftPasture) +
#   geom_line(aes(x = as.numeric(year), y = CalcNLeftPasture, linetype = pathway, colour = pathway),
#             linewidth = 1)+
#   facet_wrap(~country)
View(db_NleftPasture)
# N
# libraries ---------------------------------------------------------------
library(here)
#library(plyr)
library(dplyr)
library(tidyr)
library(readxl)
library(readr)
library(reshape2)
library(ggplot2)
library(stringr)
library(conflicted)
library(writexl)
library(openxlsx)
here()
conflicted::conflict_prefer("rename", "dplyr")
conflicted::conflict_prefer("mutate", "dplyr")
conflicted::conflict_prefer("summarise", "dplyr")
conflicted::conflicts_prefer(dplyr::filter)
aus_data <- read_xlsx(here("data", "report_AUS_20240306_9H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_affor", "GS_live_rumdensity"))
bra_data <- read_xlsx(here("data", "report_BRA_20240306_10H44.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_agrexp", "GS_diet", "GS_crop"))
col_data <- read_xlsx(here("data", "report_COL_20240325_15H07.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_crop", "GS_pop_urban"))
eth_data <- read_xlsx(here("data", "report_ETH_20240426_12H01.xlsx"), sheet = "Indicators") %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_pop", "GS_agrexp", "GS_crop"))
gbr_data <- read_xlsx(here("data", "report_GBR_20240306_10H43.xlsx"), sheet = "Indicators")  %>%
rename(Pathway = `Current Trend`) %>%
filter(Pathway %in% c("Current Trend_Yes", "NationalCommitments", "GlobalSustainability", "GS_diet", "GS_foodwaste", "GS_crop"))
all_data <- aus_data %>%
bind_rows(bra_data) %>%
bind_rows(col_data) %>%
bind_rows(eth_data) %>%
bind_rows(gbr_data) %>%
rename(country = Location, year = Year, pathway = Pathway, calcn_org = CalcN_org, calcn_synth = CalcN_synth) %>%
mutate(pathway = if_else(pathway == "Current Trend_Yes", "CurrentTrend", pathway)) %>%
mutate(country = ifelse(country == "Australia", "AUS",
ifelse(country == "Brazil", "BRA",
ifelse(country == "Ethiopia", "ETH",
ifelse(country == "UK", "GBR",
ifelse(country == "Colombia", "COL", country))))))
# file --------------------------------------------------------------------
file <- list.files(path = here("data", "SOFA extraction"))
#Extracting data from the Calculators - only run when needed
#<<<<<<< HEAD
#
# db_full <- data.frame()
#
# for (cur_file in file){
#   print(cur_file)
#   #???Extract the right sheet from calculators
#    data <- read_excel(here("data", "SOFA extraction", cur_file),
#                      sheet = "5_feas_livestock",
#                      range = "AA20:BZ175")
#   index <- which(data == "TABLE: Calc_FeasProdLivestock" | data == "TABLE: Calc_FeasProdLivestok", arr.ind = T)
#
#   if(!plyr::empty(index)){#Don't know if the table is in the calculator; we check before digging in
#     #if it is in the calc than we only want a certain amount of columns after "Biofuel_scen" cell
#     data <- data[c((index[1,1]+7):nrow(data)), c(index[1,2]:(index[1,2]+30))]
#     colnames(data) <- data[1,]
#     data <- data[-1,]
#     data <- data.frame(data[rowSums(is.na(data)) != ncol(data), ])
#
#
#     data <- data %>%
#       #slice(which(Year %in% c(2015, 2050))) %>%
#       select(ANIMAL_GLOBIOM, YEAR, FinFeasHerd) %>%
#       mutate(Pathway = ifelse(grepl("affor", cur_file),
#                               "GS_affor",
#                               ifelse(grepl("diet", cur_file),
#                                      "GS_diet",
#                                      ifelse(grepl("liverum", cur_file),
#                                             "GS_live_rum",
#                                             ifelse(grepl("agrexp", cur_file),
#                                                    "GS_agrexp",
#                                                    ifelse(grepl("crop", cur_file),
#                                                           "GS_crop",
#                                                           ifelse(grepl("popurban", cur_file),
#                                                                  "GS_pop_urban",
#                                                                  ifelse(grepl("pop", cur_file),
#                                                                         "GS_pop",
#                                                                         ifelse(grepl("foodwaste", cur_file),
#                                                                                "GS_foodwaste",
#                                                                                ifelse(grepl("Current", cur_file),
#                                                                                       "CurrentTrend",
#                                                                                       ifelse(grepl("National", cur_file),
#                                                                                              "NationalCommitments",
#                                                                                              "GlobalSustainability"))))))))))) %>%
#       mutate(ALPHA3 = ifelse(grepl("AUS", cur_file), "AUS",
#                              ifelse(grepl("BRA", cur_file), "BRA",
#                                     ifelse(grepl("COL", cur_file), "COL",
#                                            ifelse(grepl("ETH", cur_file), "ETH",
#                                                   ifelse(grepl("GBR", cur_file), "GBR",
#                                                          ifelse(grepl("Current", cur_file),
#                                                                 str_sub(cur_file, 40, 42),
#                                                                 ifelse(grepl("National", cur_file),
#                                                                        str_sub(cur_file, 46, 48),
#                                                                        str_sub(cur_file, 47, 49))))))))) %>%
#       unique()
#   }
#
#
#   db_full <- db_full %>%
#     rbind.data.frame(data) %>%
#     dplyr::mutate(ALPHA3 = gsub("_", "", ALPHA3))
# }
#
# db_herd <- db_full %>%
#   select(Pathway, ALPHA3, ANIMAL_GLOBIOM, YEAR, FinFeasHerd) %>%
#   mutate(country = ifelse(nchar(ALPHA3) == 4 , substr(ALPHA3, 2, 4),
#                           ifelse(ALPHA3 == "RME", "NMC", ALPHA3))) %>%
#   data.frame()
#
# xlsx::write.xlsx(db_herd, file = here("data",  "Manure", paste0(format(Sys.Date(),format = "%y%m%d"), "_Extracted_herdsize.xlsx")), row.names = F)
db_herd <- read_excel(here("data",  "Manure", "240513_Extracted_herdsize.xlsx")) %>%
# mutate(ALPHA3 = ifelse(ALPHA3 == "RME", "NMC",
#                        ifelse(nchar(ALPHA3)>3, stringr::str_sub(ALPHA3, 2, 4), ALPHA3))) %>%
select(-ALPHA3) %>%
rename(ALPHA3 = country) %>%
mutate(TLU = as.numeric(FinFeasHerd)) %>%
select(-FinFeasHerd)
# merge with GAMS manure data ----------------------------------------------
db_manure <- read_excel(here("data", "Manure", "Nmanure_GAMS.xlsx"),
sheet = "All_Nmanure_TLU") %>%
filter(!(is.na(ALPHA3))) %>%
pivot_longer(!ALPHA3, values_to = "Nmanure_TLU", names_to = "ANIMAL_GLOBIOM")
#Total N inputs from manure in 1000 t N for each year
db_manure_herd <- db_herd %>%
mutate(ANIMAL_GLOBIOM = ifelse(ANIMAL_GLOBIOM == "SGTD", "SGTO", ANIMAL_GLOBIOM)) %>%
left_join(db_manure) %>%
mutate(Nmanure_Anim = Nmanure_TLU*TLU/1000) %>%
group_by(Pathway, ALPHA3, YEAR) %>%
reframe(NManure = sum(Nmanure_Anim, na.rm = T)) %>%
rename_all(tolower) %>%
rename(country = alpha3) %>%
filter(!is.na(year))
View(db_manure_herd)
# CalcNLeftpasture in 1000 t N
db_N <- all_data %>%
select(pathway, country, year, calcn_org, calcn_synth) %>%
######################### CAREFUL ONLY HAVE EXTRACTED WITH TRADE ADJUSTMENT ###############################
#filter(tradeadjustment == "Yes") %>%
################################################################################
mutate(year = as.character(year))
View(db_N)
View(all_data)
# CalcNLeftpasture in 1000 t N
db_N <- all_data %>%
select(pathway, country, year, calcn_org, calcn_synth) %>%
######################### CAREFUL ONLY HAVE EXTRACTED WITH TRADE ADJUSTMENT ###############################
#filter(tradeadjustment == "Yes") %>%
################################################################################
mutate(year = as.character(year)) %>%
mutate(Pathway = if_else(Pathway == "GS_live_rumdensity", "GS_live_rum", Pathway))
db_NleftPasture <- db_manure_herd %>%
left_join(db_N) %>%
mutate(NPasture_beforeadj = nmanure - calcn_org,
CalcNLeftPasture = pmax(0, nmanure - calcn_org))
# CalcNLeftpasture in 1000 t N
db_N <- all_data %>%
select(pathway, country, year, calcn_org, calcn_synth) %>%
######################### CAREFUL ONLY HAVE EXTRACTED WITH TRADE ADJUSTMENT ###############################
#filter(tradeadjustment == "Yes") %>%
################################################################################
mutate(year = as.character(year)) %>%
mutate(pathway = if_else(pathway == "GS_live_rumdensity", "GS_live_rum", pathway))
db_NleftPasture <- db_manure_herd %>%
left_join(db_N) %>%
mutate(NPasture_beforeadj = nmanure - calcn_org,
CalcNLeftPasture = pmax(0, nmanure - calcn_org))
write.xlsx(db_NleftPasture, file = here("output", "N", paste0(format(Sys.Date(), format = "%y%m%d"), "_ExpostNComputations_SOFA.xlsx")))
View(db_NleftPasture)
